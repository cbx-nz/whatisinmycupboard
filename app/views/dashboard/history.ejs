<div class="dashboard-history">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">üìú Consumption History</h1>
        <a href="/api/export/history/csv?days=<%= days %>" class="btn btn-secondary">
            üì• Export CSV
        </a>
    </div>

    <!-- Date Range Filter -->
    <div class="filters-bar">
        <form action="/dashboard/history" method="GET" class="filters-form">
            <label for="days" class="filter-label">Show last:</label>
            <select name="days" id="days" class="filter-select" onchange="this.form.submit()">
                <option value="7" <%= days === 7 ? 'selected' : '' %>>7 days</option>
                <option value="14" <%= days === 14 ? 'selected' : '' %>>14 days</option>
                <option value="30" <%= days === 30 ? 'selected' : '' %>>30 days</option>
                <option value="60" <%= days === 60 ? 'selected' : '' %>>60 days</option>
                <option value="90" <%= days === 90 ? 'selected' : '' %>>90 days</option>
                <option value="365" <%= days === 365 ? 'selected' : '' %>>1 year</option>
            </select>
        </form>
    </div>

    <% if (history.length === 0) { %>
        <!-- Empty State -->
        <div class="empty-state">
            <span class="empty-icon">üìú</span>
            <h2>No history yet</h2>
            <p>Consumption will be tracked when you use, discard, or mark items as expired.</p>
            <a href="/dashboard" class="btn btn-primary">Back to Dashboard</a>
        </div>
    <% } else { %>
        <!-- History Table -->
        <div class="history-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Item</th>
                        <th>Action</th>
                        <th>Amount</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <% history.forEach(function(record) { %>
                        <tr class="action-<%= record.action %>">
                            <td class="cell-date">
                                <%= new Date(record.consumed_at).toLocaleDateString() %>
                                <span class="time-sub"><%= new Date(record.consumed_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %></span>
                            </td>
                            <td class="cell-title">
                                <% if (record.item_id) { %>
                                    <a href="/dashboard/item/<%= record.item_id %>"><%= record.item_title %></a>
                                <% } else { %>
                                    <%= record.item_title %>
                                    <span class="deleted-badge">(deleted)</span>
                                <% } %>
                            </td>
                            <td class="cell-action">
                                <% if (record.action === 'used') { %>
                                    <span class="action-badge used">‚úì Used</span>
                                <% } else if (record.action === 'discarded') { %>
                                    <span class="action-badge discarded">üóëÔ∏è Discarded</span>
                                <% } else if (record.action === 'expired') { %>
                                    <span class="action-badge expired">‚ö†Ô∏è Expired</span>
                                <% } %>
                            </td>
                            <td class="cell-amount"><%= record.quantity_used %> <%= record.unit %></td>
                            <td class="cell-notes"><%= record.notes || '‚Äî' %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>

        <!-- Summary Stats -->
        <div class="history-summary">
            <h3>Summary (Last <%= days %> days)</h3>
            <div class="summary-stats">
                <div class="summary-stat">
                    <span class="stat-value"><%= history.length %></span>
                    <span class="stat-label">Total Events</span>
                </div>
                <div class="summary-stat">
                    <span class="stat-value"><%= history.filter(h => h.action === 'used').length %></span>
                    <span class="stat-label">Items Used</span>
                </div>
                <div class="summary-stat">
                    <span class="stat-value"><%= history.filter(h => h.action === 'discarded' || h.action === 'expired').length %></span>
                    <span class="stat-label">Items Wasted</span>
                </div>
            </div>
        </div>
    <% } %>
</div>
